<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jQuery Traceroute Test</title>
    <style>
        /* Bootstrap-like styles */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .mt-4 { margin-top: 1.5rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .row { display: flex; flex-wrap: wrap; margin: 0 -15px; }
        .col-12 { flex: 0 0 100%; max-width: 100%; padding: 0 15px; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; padding: 0 15px; }
        .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; padding: 0 15px; }
        .card { background: #fff; border: 1px solid #dee2e6; border-radius: 0.375rem; margin-bottom: 1rem; }
        .card-header { padding: 0.75rem 1rem; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .card-body { padding: 1rem; }
        .card-title { margin: 0; font-size: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control, .form-select { display: block; width: 100%; padding: 0.375rem 0.75rem; border: 1px solid #ced4da; border-radius: 0.375rem; }
        .btn { display: inline-block; padding: 0.375rem 0.75rem; border: 1px solid transparent; border-radius: 0.375rem; text-decoration: none; cursor: pointer; }
        .btn-primary { background: #0d6efd; border-color: #0d6efd; color: #fff; }
        .btn-secondary { background: #6c757d; border-color: #6c757d; color: #fff; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem; border-bottom: 1px solid #dee2e6; text-align: left; }
        .table-striped tbody tr:nth-child(odd) { background: #f8f9fa; }
        .table-dark { background: #212529; color: #fff; }
        .badge { display: inline-block; padding: 0.35em 0.65em; font-size: 0.75em; font-weight: 700; border-radius: 0.375rem; }
        .bg-info { background: #0dcaf0; color: #000; }
        .bg-success { background: #198754; color: #fff; }
        .bg-warning { background: #ffc107; color: #000; }
        .bg-danger { background: #dc3545; color: #fff; }
        .bg-secondary { background: #6c757d; color: #fff; }
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        .fw-bold { font-weight: 700; }
        .fw-semibold { font-weight: 600; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .table-responsive { overflow-x: auto; }
        .spinner-border { display: inline-block; width: 2rem; height: 2rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .position-fixed { position: fixed; }
        .top-0 { top: 0; }
        .start-0 { left: 0; }
        .end-0 { right: 0; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        .bg-dark { background: #212529; }
        .bg-opacity-50 { opacity: 0.5; }
        .d-flex { display: flex; }
        .justify-content-center { justify-content: center; }
        .align-items-center { align-items: center; }
        .p-3 { padding: 1rem; }
        .alert { padding: 0.75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.375rem; }
        .alert-info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .alert-danger { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .alert-warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .alert-dismissible { padding-right: 4rem; }
        .btn-close { position: absolute; top: 0; right: 0; z-index: 2; padding: 0.75rem 1.25rem; }
        .fade { transition: opacity 0.15s linear; }
        .show { opacity: 1; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .text-light { color: #f8f9fa; }
        .z-index-9999 { z-index: 9999; }
        .overflow-y-auto { overflow-y: auto; }
        .font-family-monospace { font-family: monospace; }
        .font-size-12px { font-size: 12px; }
        .background-color-f8f9fa { background-color: #f8f9fa; }
        .padding-10px { padding: 10px; }
        .height-200px { height: 200px; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    üõ£Ô∏è jQuery Traceroute Test
                </h1>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Traceroute Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="traceroute-target" class="form-label">Target Host</label>
                                    <input type="text" class="form-control" id="traceroute-target" value="1.1.1.1" placeholder="192.168.1.1 or google.com">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="traceroute-max-hops" class="form-label">Max Hops</label>
                                    <input type="number" class="form-control" id="traceroute-max-hops" value="4" min="1" max="255">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="traceroute-protocol" class="form-label">Protocol</label>
                                    <select class="form-select" id="traceroute-protocol">
                                        <option value="icmp">ICMP</option>
                                        <option value="udp">UDP</option>
                                        <option value="tcp">TCP</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="traceroute-timeout" class="form-label">Timeout (ms)</label>
                                    <input type="number" class="form-control" id="traceroute-timeout" value="5000" min="1000" max="30000">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="traceroute-count" class="form-label">Probes per Hop</label>
                                    <input type="number" class="form-control" id="traceroute-count" value="3" min="1" max="10">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="startTracerouteBtn">
                            ‚ñ∂Ô∏è Start Traceroute
                        </button>
                    </div>
                </div>

                <!-- Traceroute Results -->
                <div class="card mt-4" id="traceroute-results" style="display: none;">
                    <div class="card-header">
                        <h5>Traceroute Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="traceroute-path">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Debug Console -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Debug Console</h5>
                        <button class="btn btn-sm btn-secondary" id="clearConsole">Clear</button>
                    </div>
                    <div class="card-body">
                        <div id="debugConsole" class="height-200px overflow-y-auto background-color-f8f9fa padding-10px font-family-monospace font-size-12px">
                            <!-- Debug messages will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple jQuery-like functionality
        function $(selector) {
            if (typeof selector === 'string') {
                const elements = document.querySelectorAll(selector);
                return {
                    length: elements.length,
                    append: function(content) {
                        elements.forEach(el => {
                            if (typeof content === 'string') {
                                el.innerHTML += content;
                            } else {
                                el.appendChild(content);
                            }
                        });
                        return this;
                    },
                    html: function(content) {
                        if (content !== undefined) {
                            elements.forEach(el => el.innerHTML = content);
                            return this;
                        }
                        return elements[0] ? elements[0].innerHTML : '';
                    },
                    val: function(value) {
                        if (value !== undefined) {
                            elements.forEach(el => el.value = value);
                            return this;
                        }
                        return elements[0] ? elements[0].value : '';
                    },
                    text: function(value) {
                        if (value !== undefined) {
                            elements.forEach(el => el.textContent = value);
                            return this;
                        }
                        return elements[0] ? elements[0].textContent : '';
                    },
                    show: function() {
                        elements.forEach(el => el.style.display = '');
                        return this;
                    },
                    hide: function() {
                        elements.forEach(el => el.style.display = 'none');
                        return this;
                    },
                    remove: function() {
                        elements.forEach(el => el.remove());
                        return this;
                    },
                    empty: function() {
                        elements.forEach(el => el.innerHTML = '');
                        return this;
                    },
                    on: function(event, handler) {
                        elements.forEach(el => el.addEventListener(event, handler));
                        return this;
                    },
                    find: function(selector) {
                        const found = [];
                        elements.forEach(el => {
                            found.push(...el.querySelectorAll(selector));
                        });
                        return $(found);
                    },
                    addClass: function(className) {
                        elements.forEach(el => el.classList.add(className));
                        return this;
                    },
                    removeClass: function(className) {
                        const classes = className.split(' ');
                        elements.forEach(el => el.classList.remove(...classes));
                        return this;
                    },
                    first: function() {
                        return elements[0] ? $(elements[0]) : $();
                    },
                    scrollTop: function(value) {
                        if (value !== undefined) {
                            elements.forEach(el => el.scrollTop = value);
                            return this;
                        }
                        return elements[0] ? elements[0].scrollTop : 0;
                    },
                    after: function(content) {
                        elements.forEach(el => {
                            if (typeof content === 'string') {
                                el.insertAdjacentHTML('afterend', content);
                            } else {
                                el.parentNode.insertBefore(content, el.nextSibling);
                            }
                        });
                        return this;
                    },
                    prepend: function(content) {
                        elements.forEach(el => {
                            if (typeof content === 'string') {
                                el.innerHTML = content + el.innerHTML;
                            } else {
                                el.insertBefore(content, el.firstChild);
                            }
                        });
                        return this;
                    }
                };
            } else if (selector === document) {
                // Special handling for $(document)
                return {
                    length: 1,
                    ready: function(callback) {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', callback);
                        } else {
                            callback();
                        }
                        return this;
                    }
                };
                         } else if (selector instanceof HTMLElement) {
                 return {
                     length: 1,
                     append: function(content) {
                         if (typeof content === 'string') {
                             selector.innerHTML += content;
                         } else {
                             selector.appendChild(content);
                         }
                         return this;
                     },
                     html: function(content) {
                         if (content !== undefined) {
                             selector.innerHTML = content;
                             return this;
                         }
                         return selector.innerHTML;
                     },
                     val: function(value) {
                         if (value !== undefined) {
                             selector.value = value;
                             return this;
                         }
                         return selector.value;
                     },
                     text: function(value) {
                         if (value !== undefined) {
                             selector.textContent = value;
                             return this;
                         }
                         return selector.textContent;
                     },
                     show: function() {
                         selector.style.display = '';
                         return this;
                     },
                     hide: function() {
                         selector.style.display = 'none';
                         return this;
                     },
                     remove: function() {
                         selector.remove();
                         return this;
                     },
                     empty: function() {
                         selector.innerHTML = '';
                         return this;
                     },
                     on: function(event, handler) {
                         selector.addEventListener(event, handler);
                         return this;
                     },
                     find: function(selector) {
                         const found = selector.querySelectorAll(selector);
                         return $(found);
                     },
                     addClass: function(className) {
                         selector.classList.add(className);
                         return this;
                     },
                     removeClass: function(className) {
                         const classes = className.split(' ');
                         selector.classList.remove(...classes);
                         return this;
                     },
                     first: function() {
                         return $(selector);
                     },
                     scrollTop: function(value) {
                         if (value !== undefined) {
                             selector.scrollTop = value;
                             return this;
                         }
                         return selector.scrollTop;
                     },
                     after: function(content) {
                         if (typeof content === 'string') {
                             selector.insertAdjacentHTML('afterend', content);
                         } else {
                             selector.parentNode.insertBefore(content, selector.nextSibling);
                         }
                         return this;
                     },
                     prepend: function(content) {
                         if (typeof content === 'string') {
                             selector.innerHTML = content + selector.innerHTML;
                         } else {
                             selector.insertBefore(content, selector.firstChild);
                         }
                         return this;
                     }
                 };
             } else if (Array.isArray(selector)) {
    const elements = selector.filter(el => el instanceof HTMLElement);
    return {
        length: elements.length,
        append: function(content) {
            elements.forEach(el => {
                if (typeof content === 'string') {
                    el.innerHTML += content;
                } else {
                    el.appendChild(content);
                }
            });
            return this;
        },
        html: function(content) {
            if (content !== undefined) {
                elements.forEach(el => el.innerHTML = content);
                return this;
            }
            return elements[0] ? elements[0].innerHTML : '';
        },
        val: function(value) {
            if (value !== undefined) {
                elements.forEach(el => el.value = value);
                return this;
            }
            return elements[0] ? elements[0].value : '';
        },
        text: function(value) {
            if (value !== undefined) {
                elements.forEach(el => el.textContent = value);
                return this;
            }
            return elements[0] ? elements[0].textContent : '';
        },
        show: function() {
            elements.forEach(el => el.style.display = '');
            return this;
        },
        hide: function() {
            elements.forEach(el => el.style.display = 'none');
            return this;
        },
        remove: function() {
            elements.forEach(el => el.remove());
            return this;
        },
        empty: function() {
            elements.forEach(el => el.innerHTML = '');
            return this;
        },
        on: function(event, handler) {
            elements.forEach(el => el.addEventListener(event, handler));
            return this;
        },
        find: function(sel) {
            let found = [];
            elements.forEach(el => {
                found.push(...el.querySelectorAll(sel));
            });
            return $(found);
        },
        addClass: function(className) {
            elements.forEach(el => el.classList.add(className));
            return this;
        },
        removeClass: function(className) {
            const classes = className.split(' ');
            elements.forEach(el => el.classList.remove(...classes));
            return this;
        },
        first: function() {
            return elements[0] ? $(elements[0]) : $();
        },
        scrollTop: function(value) {
            if (value !== undefined) {
                elements.forEach(el => el.scrollTop = value);
                return this;
            }
            return elements[0] ? elements[0].scrollTop : 0;
        },
        after: function(content) {
            elements.forEach(el => {
                if (typeof content === 'string') {
                    el.insertAdjacentHTML('afterend', content);
                } else {
                    el.parentNode.insertBefore(content, el.nextSibling);
                }
            });
            return this;
        },
        prepend: function(content) {
            elements.forEach(el => {
                if (typeof content === 'string') {
                    el.innerHTML = content + el.innerHTML;
                } else {
                    el.insertBefore(content, el.firstChild);
                }
            });
            return this;
        }
    };
}
            return { length: 0 };
        }

        // Also attach ready to the $ function itself
        $.ready = function(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        };

        // Debug logging function
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            const debugConsole = document.getElementById('debugConsole');
            if (debugConsole) {
                debugConsole.innerHTML += logEntry;
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
            console.log(message);
        }

        // jQuery-based Traceroute Module for Real-time Updates
        class TraceroutejQuery {
            constructor() {
                this.currentTracerouteData = null;
                this.socket = io();
                this.setupSocketHandlers();
                this.setupEventHandlers();
                debugLog('üîß jQuery Traceroute module initialized');
            }

            setupSocketHandlers() {
                debugLog('üîç Setting up socket handlers...');
                
                // Socket event handlers using jQuery
                this.socket.on('traceroute-route-discovered', (data) => {
                    debugLog('üîç Route discovered: ' + JSON.stringify(data));
                    this.handleRouteDiscovered(data);
                });

                this.socket.on('traceroute-hop-discovered', (data) => {
                    debugLog('üîç Hop discovered: ' + JSON.stringify(data));
                    this.handleHopDiscovered(data);
                });

                this.socket.on('traceroute-hop-update', (data) => {
                    debugLog('üîç Hop update: ' + JSON.stringify(data));
                    this.handleHopUpdate(data);
                });

                this.socket.on('traceroute-batch-progress', (data) => {
                    debugLog('üîç Batch progress: ' + JSON.stringify(data));
                    this.handleBatchProgress(data);
                });

                this.socket.on('traceroute-complete', (data) => {
                    debugLog('üîç Traceroute complete: ' + JSON.stringify(data));
                    this.handleComplete(data);
                });

                this.socket.on('traceroute-error', (data) => {
                    debugLog('üîç Traceroute error: ' + JSON.stringify(data));
                    this.handleError(data);
                });

                this.socket.on('connect', () => {
                    debugLog('‚úÖ Socket connected');
                });

                this.socket.on('disconnect', () => {
                    debugLog('‚ùå Socket disconnected');
                });
            }

            setupEventHandlers() {
                $('#startTracerouteBtn').on('click', () => {
                    this.startTraceroute();
                });

                $('#stopTracerouteBtn').on('click', () => {
                    this.stopTraceroute();
                });
            }

            async startTraceroute() {
                debugLog('üîç Starting traceroute...');
                
                const target = $('#traceroute-target').val();
                const maxHops = parseInt($('#traceroute-max-hops').val());
                const protocol = $('#traceroute-protocol').val();
                const timeout = parseInt($('#traceroute-timeout').val());
                const count = parseInt($('#traceroute-count').val());

                debugLog('üîç Form values - target: ' + target + ', maxHops: ' + maxHops + ', protocol: ' + protocol + ', timeout: ' + timeout + ', count: ' + count);

                if (!target) {
                    this.showNotification('Please enter a target host', 'error');
                    return;
                }

                this.initializeDisplay(target);
                this.showLoading();

                try {
                    const response = await fetch('/api/v2/traceroute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            host: target,
                            maxHops,
                            protocol,
                            timeout,
                            packetSize: 56,
                            count
                        })
                    });

                    const data = await response.json();
                    debugLog('üîç API response: ' + JSON.stringify(data));

                    if (data.roomId) {
                        this.socket.emit('join-room', data.roomId);
                        debugLog('üîç Joined room: ' + data.roomId);
                    }

                    // Check if we received complete data immediately
                    if (data.success && data.data && data.data.hops) {
                        debugLog('üîç Received complete data immediately, populating table...');
                        this.handleComplete(data.data);
                        return;
                    }

                    this.currentTracerouteData = {
                        host: target,
                        hops: new Map(),
                        startTime: new Date().toISOString(),
                        status: 'running'
                    };

                    this.showNotification(`Starting traceroute to ${target}`, 'info');

                } catch (error) {
                    debugLog('‚ùå Error starting traceroute: ' + error.message);
                    this.showNotification('Traceroute failed: ' + error.message, 'error');
                    this.hideLoading();
                }
            }

            initializeDisplay(target) {
                debugLog('üîç Initializing display for: ' + target);
                
                const tableHTML = `
                    <div class="traceroute-header mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">Target: ${target}</h4>
                                <span class="badge bg-info" id="statusBadge">Discovering route...</span>
                            </div>
                            <div>
                                <button class="btn btn-secondary btn-sm" id="stopTracerouteBtn">
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Hop</th>
                                    <th>Host</th>
                                    <th>Loss</th>
                                    <th>Sent</th>
                                    <th>Last</th>
                                    <th>Avg.</th>
                                    <th>Best</th>
                                    <th>Worst</th>
                                    <th>Std Dev.</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="traceroute-hops">
                                <tr class="text-muted">
                                    <td colspan="10" class="text-center">
                                        <span class="spinner-border"></span> Discovering route...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                $('#traceroute-path').html(tableHTML);
                $('#traceroute-results').show();
                
                debugLog('‚úÖ Display initialized');
            }

            handleRouteDiscovered(data) {
                debugLog('üîç Handling route discovered: ' + data.hops.length + ' hops');
                
                $('#statusBadge').text('Pinging Hops').removeClass('bg-info').addClass('bg-warning');
                
                if (!this.currentTracerouteData) {
                    this.currentTracerouteData = {
                        host: data.target,
                        hops: new Map()
                    };
                }

                // Clear loading row
                $('#traceroute-hops').empty();
                
                // Add all discovered hops
                data.hops.forEach(hop => {
                    this.currentTracerouteData.hops.set(hop.hop.toString(), {
                        ...hop,
                        times: [],
                        sent: 0,
                        received: 0,
                        loss: 0,
                        last: null,
                        avg: null,
                        best: null,
                        worst: null,
                        stdDev: null
                    });
                    
                    this.addHopRow(hop);
                });

                this.showNotification(`Route discovered: ${data.hops.length} hops found. Starting ping measurements...`, 'info');
            }

            handleHopDiscovered(data) {
                debugLog('üîç Handling hop discovered: ' + data.hop.hop);
                
                const hop = data.hop;
                
                if (!this.currentTracerouteData) {
                    this.currentTracerouteData = {
                        host: data.target,
                        hops: new Map()
                    };
                }

                this.currentTracerouteData.hops.set(hop.hop.toString(), {
                    ...hop,
                    times: [],
                    sent: 0,
                    received: 0,
                    loss: 0,
                    last: null,
                    avg: null,
                    best: null,
                    worst: null,
                    stdDev: null
                });

                this.addHopRow(hop);
                this.updateHopDisplayRealTime(hop);
            }

            handleHopUpdate(data) {
                debugLog('üîç Handling hop update: ' + data.hop.hop);
                
                const { target, hop } = data;
                
                if (!this.currentTracerouteData) {
                    this.currentTracerouteData = {
                        host: target,
                        hops: new Map()
                    };
                }

                this.currentTracerouteData.hops.set(hop.hop.toString(), hop);
                this.updateHopDisplay(hop);
            }

            handleBatchProgress(data) {
                const { currentBatch, totalBatches, currentHops, totalHops } = data;
                
                $('#statusBadge').text(`Pinging Batch ${currentBatch}/${totalBatches} (${currentHops}/${totalHops} hops)`);
                
                this.showNotification(`Processing batch ${currentBatch}/${totalBatches}: hops ${currentHops}-${Math.min(currentHops + 4, totalHops)}`, 'info');
            }

            handleComplete(data) {
                debugLog('üîç Handling complete: ' + data.hops.length + ' hops');
                debugLog('üîç Complete data: ' + JSON.stringify(data));
                
                $('#statusBadge').text('Complete').removeClass('bg-warning').addClass('bg-success');
                
                // Update all hop rows with final data
                if (data.hops && Array.isArray(data.hops)) {
                    data.hops.forEach(hop => {
                        debugLog('üîç Updating final hop data for hop ' + hop.hop + ': ' + JSON.stringify(hop));
                        this.updateHopDisplay(hop);
                    });
                }
                
                this.updateFinalStats(data);
                
                if (this.currentTracerouteData) {
                    this.currentTracerouteData.completed = true;
                    this.currentTracerouteData.endTime = new Date().toISOString();
                    this.currentTracerouteData.results = data;
                }

                this.hideLoading();
                this.showNotification('Traceroute completed successfully', 'success');
            }

            handleError(data) {
                debugLog('üîç Handling error: ' + data.error);
                
                $('#statusBadge').text('Error').removeClass('bg-info bg-warning').addClass('bg-danger');
                
                this.hideLoading();
                this.showNotification(`Traceroute failed: ${data.error}`, 'error');
            }

            addHopRow(hop) {
                debugLog('üîç Adding hop row: ' + hop.hop);
                
                // Handle different hostname formats
                const hostname = hop.hostname || hop.host || hop.ip;
                const ip = hop.ip || hop.address || '*';
                
                const rowHTML = `
                    <tr data-hop="${hop.hop}">
                        <td class="fw-bold">${hop.hop}</td>
                        <td>
                            <div>
                                <div class="fw-semibold">${hostname}</div>
                                <small class="text-muted">${ip}</small>
                            </div>
                        </td>
                        <td class="loss-percentage">-</td>
                        <td class="packets-sent">-</td>
                        <td class="latency-last">-</td>
                        <td class="latency-avg">-</td>
                        <td class="latency-best">-</td>
                        <td class="latency-worst">-</td>
                        <td class="std-dev">-</td>
                        <td><span class="badge bg-secondary">Pending</span></td>
                    </tr>
                `;

                // Remove loading row if exists
                const loadingRows = document.querySelectorAll('#traceroute-hops tr');
                loadingRows.forEach(row => {
                    if (row.textContent.includes('Discovering route')) {
                        row.remove();
                    }
                });
                
                // Add new row
                $('#traceroute-hops').append(rowHTML);
                
                debugLog('‚úÖ Hop row added for hop ' + hop.hop);
            }

            updateHopDisplayRealTime(hop) {
                debugLog('üîç Updating hop display real-time: ' + hop.hop);
                
                const row = $(`#traceroute-hops tr[data-hop="${hop.hop}"]`);
                
                if (row.length === 0) {
                    this.addHopRow(hop);
                    return;
                }

                let rtt1 = '-';
                if (hop.rtt1) {
                    rtt1 = hop.rtt1 === '<1 ms' ? '0.5ms' : hop.rtt1;
                }

                let statusClass = 'bg-success';
                let statusText = 'Discovered';

                if (hop.ip === '*') {
                    statusClass = 'bg-danger';
                    statusText = 'Unreachable';
                }

                row.find('.latency-last').text(rtt1);
                row.find('td:last-child .badge')
                   .removeClass('bg-secondary bg-success bg-danger')
                   .addClass(statusClass)
                   .text(statusText);
            }

            updateHopDisplay(hop) {
                debugLog('üîç Updating hop display: ' + hop.hop);
                debugLog('üîç Hop data: ' + JSON.stringify(hop));
                
                const row = $(`#traceroute-hops tr[data-hop="${hop.hop}"]`);
                
                if (row.length === 0) {
                    this.addHopRow(hop);
                    return;
                }

                // Handle different data formats from API
                const loss = hop.loss !== undefined ? hop.loss : (hop.received && hop.sent ? ((hop.sent - hop.received) / hop.sent * 100) : 0);
                const sent = hop.sent || 0;
                const received = hop.received || 0;
                const last = hop.last || hop.rtt1 || null;
                const avg = hop.avg || hop.rtt2 || null;
                const best = hop.best || hop.rtt3 || null;
                const worst = hop.worst || null;
                const stdDev = hop.stdDev || null;

                // Update hostname if available
                if (hop.hostname && hop.hostname !== hop.ip) {
                    row.find('td:nth-child(2) .fw-semibold').text(hop.hostname);
                }

                const statusClass = loss === 0 ? 'bg-success' : loss < 50 ? 'bg-warning' : 'bg-danger';
                const statusText = loss === 0 ? 'OK' : loss < 50 ? 'Partial' : 'High Loss';

                row.find('.loss-percentage').text(`${loss.toFixed(1)}%`);
                row.find('.packets-sent').text(sent);
                row.find('.latency-last').text(last ? `${parseFloat(last).toFixed(1)}ms` : '-');
                row.find('.latency-avg').text(avg ? `${parseFloat(avg).toFixed(1)}ms` : '-');
                row.find('.latency-best').text(best ? `${parseFloat(best).toFixed(1)}ms` : '-');
                row.find('.latency-worst').text(worst ? `${parseFloat(worst).toFixed(1)}ms` : '-');
                row.find('.std-dev').text(stdDev ? `${parseFloat(stdDev).toFixed(1)}ms` : '-');
                row.find('td:last-child .badge')
                   .removeClass('bg-secondary bg-success bg-warning bg-danger')
                   .addClass(statusClass)
                   .text(statusText);
                
                debugLog('‚úÖ Hop display updated for hop ' + hop.hop);
            }

            updateFinalStats(data) {
                const { hops, totalTime } = data;
                
                const summaryHTML = `
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${hops.length}</h5>
                                    <p class="card-text">Total Hops</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${totalTime}ms</h5>
                                    <p class="card-text">Total Time</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">${hops.filter(h => h.loss < 100).length}</h5>
                                    <p class="card-text">Reachable Hops</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                $('.traceroute-header').after(summaryHTML);
            }

            stopTraceroute() {
                this.socket.emit('leave-room');
                $('#statusBadge').text('Stopped').removeClass('bg-info bg-warning').addClass('bg-secondary');
                this.hideLoading();
                this.showNotification('Traceroute stopped', 'info');
            }

            showLoading() {
                const overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center';
                overlay.style.zIndex = '9999';
                overlay.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
                document.body.appendChild(overlay);
            }

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.remove();
            }

            showNotification(message, type) {
                const alertClass = type === 'error' ? 'alert-danger' : 
                                  type === 'success' ? 'alert-success' : 
                                  type === 'warning' ? 'alert-warning' : 'alert-info';
                
                const alertHTML = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" onclick="this.parentElement.remove()">√ó</button>
                    </div>
                `;

                let notificationArea = document.getElementById('notificationArea');
                if (!notificationArea) {
                    notificationArea = document.createElement('div');
                    notificationArea.id = 'notificationArea';
                    notificationArea.className = 'position-fixed top-0 end-0 p-3';
                    notificationArea.style.zIndex = '9999';
                    document.body.insertBefore(notificationArea, document.body.firstChild);
                }

                notificationArea.innerHTML += alertHTML;

                setTimeout(() => {
                    const alerts = notificationArea.querySelectorAll('.alert');
                    if (alerts.length > 0) {
                        alerts[0].remove();
                    }
                }, 5000);
            }
        }

        // Initialize when document is ready
        $(document).ready(() => {
            debugLog('üöÄ Page loaded, initializing jQuery Traceroute...');
            
            // Clear console
            $('#clearConsole').on('click', () => {
                $('#debugConsole').empty();
            });
            
            // Initialize traceroute
            window.traceroutejQuery = new TraceroutejQuery();
        });
    </script>
</body>
</html> 